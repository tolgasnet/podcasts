<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deep Science Digest</title>
  <meta name="description" content="Bite-size episodes on science, tech, and startup ideas." />
  <meta property="og:title" content="Deep Science Digest" />
  <meta property="og:description" content="Bite-size episodes on science, tech, and startup ideas." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#ffffff" />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,600;1,8..60,400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #ff6a3d;
      --radius: 14px;
      --shadow: 0 6px 16px rgba(17,24,39,.06);
      --shadow-hover: 0 12px 30px rgba(17,24,39,.10);
      --link: #0ea5e9;
      --ring: rgba(14,165,233,.25);
      --wrap: 820px;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0f14;
        --panel: #0f141a;
        --ink: #e5e7eb;
        --muted: #94a3b8;
        --line: #1f2937;
        --shadow: 0 8px 20px rgba(0,0,0,.35);
        --shadow-hover: 0 16px 36px rgba(0,0,0,.45);
        --link: #7dd3fc;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap { max-width: var(--wrap); margin: 0 auto; padding: 32px 18px 56px; }

    /* Header */
    header {
      display: grid;
      gap: 6px;
      padding: 24px 0 18px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 16px;
    }
    .brand { display: flex; align-items: center; gap: 14px; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: conic-gradient(from 200deg, #ff6a3d, #fbbf24, #22d3ee, #ff6a3d);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 14%, transparent);
    }
    h1 {
      font-family: "Source Serif 4", ui-serif, Georgia, Cambria, "Times New Roman", serif;
      font-weight: 600;
      font-size: 34px;
      letter-spacing: .1px;
      margin: 0;
      line-height: 1.1;
    }
    header p {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: 15px;
    }

    /* Subscribe / top links */
    .top-actions {
      display: flex; gap: 10px; flex-wrap: wrap;
      margin-top: 14px;
    }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      text-decoration: none;
      border: 1px solid var(--line);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--ink);
      background: var(--panel);
      box-shadow: var(--shadow);
      transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease;
    }
    .btn:hover { box-shadow: var(--shadow-hover); border-color: color-mix(in srgb, var(--ink) 10%, var(--line)); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--ink); color: #fff; border-color: var(--ink); }
    .btn.primary:hover { box-shadow: var(--shadow-hover); }

    /* Episodes */
    .episodes { margin-top: 18px; display: grid; gap: 18px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease;
    }
    .card:hover { box-shadow: var(--shadow-hover); border-color: color-mix(in srgb, var(--ink) 10%, var(--line)); }
    .title {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: baseline;
      margin-bottom: 10px;
    }
    .title h3 {
      margin: 0;
      font-family: "Source Serif 4", ui-serif, Georgia, Cambria, "Times New Roman", serif;
      font-weight: 600;
      font-size: 20px;
      line-height: 1.25;
      letter-spacing: .2px;
    }
    .meta { color: var(--muted); font-size: 13px; text-align: right; white-space: nowrap; }
    .submeta { color: var(--muted); font-size: 13px; margin: 8px 0 10px; }
    audio { width: 100%; outline: none; border-radius: 10px; }
    .links { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }

    .link {
      color: var(--link);
      text-decoration: none;
      border-bottom: 1px solid color-mix(in srgb, var(--link) 40%, transparent);
      padding-bottom: 1px;
    }
    .link:hover { border-bottom-color: var(--link); }

    .empty, .loading, .error {
      color: var(--muted);
      text-align: center;
      margin: 28px 0;
      font-size: 15px;
    }
    .loading::after { content: "â€¦"; animation: dots 1.2s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content:""; } 40% { content:"."; } 60% { content:".."; } 80%, 100% { content:"..."; } }

    footer {
      margin-top: 32px;
      padding-top: 18px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }

    @media (min-width: 720px) {
      .wrap { padding: 40px 22px 72px; }
      h1 { font-size: 40px; }
      .title h3 { font-size: 22px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Deep Science Digest</h1>
      </div>
      <p>Bite-size insights from the frontiers of science, technology, and innovation.</p>

      <div class="top-actions">
        <!-- Swap these hrefs to your real links if you add them -->
        <a class="btn primary" href="#subscribe">Subscribe</a>
        <a class="btn" href="#rss">RSS</a>
        <a class="btn" href="https://github.com/tolgasnet/podcasts" target="_blank" rel="noopener">GitHub</a>
      </div>
    </header>

    <div id="status" class="loading" role="status">Loading</div>
    <section id="episodes" class="episodes" hidden></section>

    <footer>
      Â© <span id="year"></span> Deep Science Podcasts
    </footer>
  </div>

  <script>
    // ðŸ”§ EDIT THESE 3 LINES
    const OWNER   = 'tolgasnet';
    const REPO    = 'podcasts';
    const PATH    = 'episodes';
    const BRANCH  = 'main';

    const API = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;
    const RAW = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${PATH}/`;

    const $episodes = document.getElementById('episodes');
    const $status   = document.getElementById('status');
    document.getElementById('year').textContent = new Date().getFullYear();

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes)) return '';
      const u = ['B','KB','MB','GB']; let i = 0;
      while (bytes >= 1024 && i < u.length - 1) { bytes /= 1024; i++; }
      return bytes.toFixed(i ? 1 : 0) + ' ' + u[i];
    }
    function formatDuration(sec) {
      if (!Number.isFinite(sec)) return '';
      sec = Math.round(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
    }
    function nicify(filename) {
      try { filename = decodeURIComponent(filename); } catch {}
      let name = filename.replace(/\.[^/.]+$/, '');

      // Extract date prefix like 2025-08-30_ or 2025_08_30-
      const dateMatch = name.match(/^(\d{4})[-_](\d{2})[-_](\d{2})[-_ ]?/);
      if (dateMatch) {
        name = name.slice(dateMatch[0].length);
      }

      name = name.replace(/[-_]+/g, ' ');
      name = name.split(' ').map(word => {
        const upper = word.toUpperCase();
        if (['DNA','RNA','AI','ML','CRISPR'].includes(upper)) return upper;
        return word.charAt(0).toUpperCase() + word.slice(1);
      }).join(' ');
      return name.trim();
    }
    function extractDateFromName(name) {
      const m = name.match(/^(\d{4})[-_](\d{2})[-_](\d{2})/);
      if (!m) return null;
      const d = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00Z`);
      return Number.isNaN(d.getTime()) ? null : d;
    }
    function formatUKDate(d) {
      return d ? d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : null;
    }

    async function load() {
      try {
        const res = await fetch(API, { headers: { 'Accept': 'application/vnd.github+json' }});
        if (!res.ok) throw new Error('GitHub API: ' + res.status);
        const files = await res.json();

        const mp3s = (Array.isArray(files) ? files : [])
          .filter(f => f.type === 'file' && /\.mp3$/i.test(f.name))
          .map(f => ({ ...f, parsedDate: extractDateFromName(f.name) }));

        // Sort by parsed date if present, else by name (desc)
        mp3s.sort((a, b) => {
          if (a.parsedDate && b.parsedDate) return b.parsedDate - a.parsedDate;
          if (a.parsedDate) return -1;
          if (b.parsedDate) return 1;
          return b.name.localeCompare(a.name, undefined, { numeric: true, sensitivity: 'base' });
        });

        if (mp3s.length === 0) {
          $status.className = 'empty';
          $status.textContent = 'No episodes yet. Add .mp3 files to /episodes';
          return;
        }

        $status.hidden = true;
        $episodes.hidden = false;

        for (const f of mp3s) {
          const url = RAW + encodeURIComponent(f.name).replace(/%2F/g,'/');

          const card = document.createElement('article');
          card.className = 'card';

          const dateTxt = formatUKDate(f.parsedDate);
          const sizeTxt = formatBytes(f.size);
          const metaId = crypto.randomUUID();

          card.innerHTML = `
            <div class="title">
              <h3>${nicify(f.name)}</h3>
              <div class="meta" id="${metaId}">
                ${[dateTxt, sizeTxt].filter(Boolean).join(' Â· ')}
              </div>
            </div>

            <audio controls preload="metadata" src="${url}"></audio>

            <p class="submeta">
              <a class="link" href="${url}" download>Download</a>
              &nbsp;Â·&nbsp;
              <a class="link" href="${url}" target="_blank" rel="noopener">Open in new tab</a>
              &nbsp;Â·&nbsp;
              <a class="link" href="${location.origin + location.pathname}#${encodeURIComponent(f.name)}" onclick="navigator.clipboard.writeText('${location.origin + location.pathname}#${encodeURIComponent(f.name)}'); this.textContent='Link copied'; setTimeout(()=>this.textContent='Copy link',1200); return false;">Copy link</a>
            </p>
          `;

          // Anchor for direct linking
          card.id = encodeURIComponent(f.name);

          $episodes.appendChild(card);

          // Load duration asynchronously and patch meta
          const audio = new Audio();
          audio.preload = 'metadata';
          audio.src = url;
          audio.addEventListener('loadedmetadata', () => {
            const meta = document.getElementById(metaId);
            if (meta) {
              const existing = meta.textContent ? meta.textContent.split('Â·').map(t => t.trim()).filter(Boolean) : [];
              meta.textContent = [...existing, formatDuration(audio.duration)].join(' Â· ');
            }
            audio.remove();
          });
          audio.addEventListener('error', () => audio.remove());
        }
      } catch (err) {
        console.error(err);
        $status.className = 'error';
        $status.textContent = 'Error loading episodes. Check repo is public and folder name is correct.';
      }
    }
    load();
  </script>
</body>
</html>
